{% extends "core/base.html" %}
{% load custom_filters %}

{% block title %}Аналитика — {{ block.super }}{% endblock %}

{% block content %}
<div class="management-container">
    <h2 class="mb-4">Аналитика загрузки</h2>
</div>

    <!-- ФИЛЬТРЫ -->
    <form method="get" class="row g-3 mb-4 p-3 bg-dark rounded">
        <div class="col-md-2">
            <label class="form-label">Период</label>
            <select name="period" class="form-select" onchange="this.form.submit()">
                <option value="week" {% if period == 'week' %}selected{% endif %}>Неделя</option>
                <option value="month" {% if period == 'month' %}selected{% endif %}>Месяц</option>
                <option value="year" {% if period == 'year' %}selected{% endif %}>Год</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Сотрудник</label>
            <select name="employee" class="form-select" onchange="this.form.submit()">
                <option value="all">Все</option>
                {% for emp in all_employees %}
                    <option value="{{ emp.id }}" {% if employee_id|slugify == emp.id|slugify %}selected{% endif %}>
                        {{ emp.user.username }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Тип занятия</label>
            <select name="workout" class="form-select" onchange="this.form.submit()">
                <option value="all">Все</option>
                {% for wt in workout_types %}
                    <option value="{{ wt.id }}" {% if workout_id|slugify == wt.id|slugify %}selected{% endif %}>
                        {{ wt.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Поиск</label>
            <input type="text" name="search" class="form-control" placeholder="Имя или тип..." value="{{ search_query }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Применить</button>
        </div>
    </form>

    <!-- МЕТРИКИ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-gradient-primary text-white p-3">
                <div class="fs-4">{{ total_all_hours }} ч</div>
                <div class="text-white-50">Всего часов</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-success text-white p-3">
                <div class="fs-4">{{ total_all_assignments }}</div>
                <div class="text-white-50">Смен</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-info text-white p-3">
                <div class="fs-4">{{ active_employees }}</div>
                <div class="text-white-50">Сотрудников</div>
            </div>
        </div>
        <div class="col-md-3">
            <a href="{% url 'export_operational_excel' %}?{% if period %}period={{ period }}&{% endif %}{% if employee_id != 'all' %}employee={{ employee_id }}&{% endif %}{% if workout_id != 'all' %}workout={{ workout_id }}&{% endif %}{% if search_query %}search={{ search_query }}{% endif %}"
               class="btn btn-success w-100 h-100 d-flex align-items-center justify-content-center">
                <i class="bi bi-file-earmark-excel me-2"></i>Экспорт Excel
            </a>
        </div>
    </div>

    <!-- ГРАФИКИ -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">Загрузка по сотрудникам</div>
                <div class="card-body"><canvas id="chart-emp" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">Нагрузка по дням недели</div>
                <div class="card-body"><canvas id="chart-days" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">По типам занятий</div>
                <div class="card-body"><canvas id="chart-workout" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">Загрузка по дням месяца</div>
                <div class="card-body"><canvas id="chart-dates" height="200"></canvas></div>
            </div>
        </div>
    </div>

    <!-- === ТАБЕЛЬ УЧЁТА РАБОЧЕГО ВРЕМЕНИ === -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Табель учёта за {{ all_dates.0|date:"F Y" }}</span>
        <a href="{% url 'export_operational_excel' %}?{% if period %}period={{ period }}&{% endif %}{% if employee_id != 'all' %}employee={{ employee_id }}&{% endif %}{% if workout_id != 'all' %}workout={{ workout_id }}&{% endif %}{% if search_query %}search={{ search_query }}{% endif %}"
           class="btn btn-success btn-sm">
            <i class="bi bi-file-earmark-excel me-2"></i>Экспорт Excel
        </a>
    </div>

    <!-- СТАВКА ЗА ЧАС — ВНУТРИ КАРТОЧКИ -->
    <div class="card-body border-bottom">
        <form method="get" class="d-inline-flex align-items-center gap-2">
            {% for key, value in request.GET.items %}
                {% if key != 'hour_rate' and key != 'set_hour_rate' %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            <strong>Ставка:</strong>
            <input type="number" name="hour_rate" value="{{ hour_rate }}" min="0" step="1" class="form-control form-control-sm" style="width:100px;">
            <button type="submit" name="set_hour_rate" class="btn btn-sm btn-primary">Сохранить</button>
            <span class="ms-2 text-muted">₽/час</span>
        </form>
    </div>

    <!-- ТАБЛИЦА -->
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-dark text-center">
                <thead>
                    <tr>
                        <th>Сотрудник</th>
                        {% for d in all_dates %}
                            <th style="min-width:40px;">
                                {{ d.day }}<br><small>{{ d|date:"D" }}</small>
                            </th>
                        {% endfor %}
                        <th>Часов</th>
                        <th>ЗП</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employees %}
                        <tr>
                            <td>{{ emp.user.username }}</td>
                            {% for d in all_dates %}
                                {% with hours=data|get_item:emp.id|get_item:d %}
                                    <td class="{% if hours > 0 %}bg-success text-white{% else %}bg-light text-dark{% endif %}">
                                        {% if hours > 0 %}{{ hours|floatformat:0 }}{% else %}0{% endif %}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                            <td>{{ total_hours|get_item:emp.id|floatformat:0 }}</td>
                            <td>{{ total_hours|get_item:emp.id|multiply:hour_rate|floatformat:0 }}</td>
                        </tr>
                    {% endfor %}

                    <!-- ИТОГО ПО ДНЯМ -->
                    <tr class="fw-bold bg-secondary">
    <td>Итого по дням</td>
    {% for total in daily_totals %}
        <td>{{ total|floatformat:0 }}</td>
    {% endfor %}
    <td>{{ total_all_hours|floatformat:0 }}</td>
    <td>{{ total_all_hours|multiply:hour_rate|floatformat:0 }}</td>
</tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

</div>





<!-- ДАННЫЕ -->
<script id="report-data" type="application/json">
{{ chart_data_json|safe }}
</script>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataEl = document.getElementById('report-data');
    if (!dataEl) return;

    let data;
    try {
        data = JSON.parse(dataEl.textContent);
    } catch (e) {
        console.error("Ошибка парсинга данных:", e);
        return;
    }

    // 1. Сотрудники
    const empEl = document.getElementById('chart-emp');
    if (empEl && data.empNames?.length > 0) {
        new Chart(empEl.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.empNames,
                datasets: [{
                    label: 'Часов',
                    data: data.empValues,
                    backgroundColor: '#9b59b6'
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // 2. Дни недели
    const daysEl = document.getElementById('chart-days');
    if (daysEl && data.dayLabels?.length > 0) {
        new Chart(daysEl.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.dayLabels,
                datasets: [{
                    label: 'Часов',
                    data: data.dayValues,
                    borderColor: '#3498db',
                    fill: false,
                    tension: 0.3
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // 3. Типы
    const wtEl = document.getElementById('chart-workout');
    if (wtEl && data.workoutLabels?.length > 0) {
        new Chart(wtEl.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: data.workoutLabels,
                datasets: [{
                    data: data.workoutValues,
                    backgroundColor: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12']
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'right' } } }
        });
    }

    // 4. Дни месяца
    const datesEl = document.getElementById('chart-dates');
    if (datesEl && data.dateLabels?.length > 0) {
        new Chart(datesEl.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.dateLabels,
                datasets: [{
                    label: 'Часов',
                    data: data.dateValues,
                    backgroundColor: '#3498db'
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }
});
</script>
{% endblock %}