{% extends "core/base.html" %}
{% load custom_filters %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî {{ block.super }}{% endblock %}

{% block content %}
<div class="management-container">
    <h2 class="mb-4">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>

    <!-- –§–ò–õ–¨–¢–†–´ -->
    <form method="get" class="row g-3 mb-4 p-3 bg-dark rounded">
        <div class="col-md-2">
            <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
            <select name="period" class="form-select" onchange="this.form.submit()">
                <option value="week" {% if period == 'week' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
                <option value="month" {% if period == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                <option value="year" {% if period == 'year' %}selected{% endif %}>–ì–æ–¥</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
            <select name="employee" class="form-select" onchange="this.form.submit()">
                <option value="all">–í—Å–µ</option>
                {% for emp in all_employees %}
                    <option value="{{ emp.id }}" {% if employee_id|slugify == emp.id|slugify %}selected{% endif %}>
                        {{ emp.user.username }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç–∏—è</label>
            <select name="workout" class="form-select" onchange="this.form.submit()">
                <option value="all">–í—Å–µ</option>
                {% for wt in workout_types %}
                    <option value="{{ wt.id }}" {% if workout_id|slugify == wt.id|slugify %}selected{% endif %}>
                        {{ wt.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">–ü–æ–∏—Å–∫</label>
            <input type="text" name="search" class="form-control" placeholder="–ò–º—è –∏–ª–∏ —Ç–∏–ø..." value="{{ search_query }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </form>

    <!-- –ú–ï–¢–†–ò–ö–ò -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-gradient-primary text-white p-3">
                <div class="fs-4">{{ total_all_hours }} —á</div>
                <div class="text-white-50">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-success text-white p-3">
                <div class="fs-4">{{ total_all_assignments }}</div>
                <div class="text-white-50">–°–º–µ–Ω</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-info text-white p-3">
                <div class="fs-4">{{ active_employees }}</div>
                <div class="text-white-50">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
            </div>
        </div>
        <div class="col-md-3">
            <a href="{% url 'export_operational_excel' %}?{% if period %}period={{ period }}&{% endif %}{% if employee_id != 'all' %}employee={{ employee_id }}&{% endif %}{% if workout_id != 'all' %}workout={{ workout_id }}&{% endif %}{% if search_query %}search={{ search_query }}{% endif %}"
               class="btn btn-success w-100 h-100 d-flex align-items-center justify-content-center">
                <i class="bi bi-file-earmark-excel me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç Excel
            </a>
        </div>
    </div>

    <!-- –ì–†–ê–§–ò–ö–ò -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>
                <div class="card-body"><canvas id="chart-emp" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">–ù–∞–≥—Ä—É–∑–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</div>
                <div class="card-body"><canvas id="chart-days" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">–ü–æ —Ç–∏–ø–∞–º –∑–∞–Ω—è—Ç–∏–π</div>
                <div class="card-body"><canvas id="chart-workout" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ –¥–Ω—è–º</div>
                <div class="card-body"><canvas id="chart-dates" height="200"></canvas></div>
            </div>
        </div>
    </div>

    <!-- –¢–ê–ë–ï–õ–¨ -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>üìã –¢–∞–±–µ–ª—å —É—á—ë—Ç–∞ –∑–∞ {{ all_dates.0|date:"F Y" }}</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-dark text-center">
                    <thead>
                        <tr>
                            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            {% for d in all_dates %}
                                <th style="min-width:40px;">
                                    {{ d.day }}<br><small>{{ d|date:"D" }}</small>
                                </th>
                            {% endfor %}
                            <th>–°–º–µ–Ω</th>
                            <th>–ß–∞—Å–æ–≤</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp in employees %}
                            <tr>
                                <td>{{ emp.user.username }}</td>
                                {% for d in all_dates %}
                                    {% with hours=data|get_item:emp.id|get_item:d %}
                                        <td class="{% if hours > 0 %}bg-success text-white{% else %}bg-light text-dark{% endif %}">
                                            {% if hours > 0 %}{{ hours|floatformat:1 }}{% else %}0{% endif %}
                                        </td>
                                    {% endwith %}
                                {% endfor %}
                                <td>{{ total_shifts|get_item:emp.id }}</td>
                                <td>{{ total_hours|get_item:emp.id }}</td>
                            </tr>
                        {% endfor %}
                        <tr class="fw-bold bg-secondary">
                            <td>–ò—Ç–æ–≥–æ</td>
                            {% for d in all_dates %}
                                <td>
                                    {% with total=0 %}
                                        {% for emp in employees %}
                                            {% with h=data|get_item:emp.id|get_item:d %}
                                                {% if h > 0 %}
                                                    {% with total=total|hadd:h %}
                                                        {{ total|floatformat:1 }}
                                                    {% endwith %}
                                                {% endif %}
                                            {% endwith %}
                                        {% endfor %}
                                    {% endwith %}
                                </td>
                            {% endfor %}
                            <td>{{ total_shifts.values|length }}</td>
                            <td>{{ total_all_hours|floatformat:2 }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- –î–ê–ù–ù–´–ï –î–õ–Ø –ì–†–ê–§–ò–ö–û–í -->
<script id="report-data" type="application/json">
{{ chart_data_json|safe }}
</script>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataEl = document.getElementById('report-data');
    if (!dataEl) return;

    let data;
    try {
        data = JSON.parse(dataEl.textContent);
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:", e);
        return;
    }

    // 1. –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
    const empEl = document.getElementById('chart-emp');
    if (empEl && data.empNames?.length > 0) {
        new Chart(empEl.getContext('2d'), {
            type: 'bar',
             { labels: data.empNames, datasets: [{ label: '–ß–∞—Å–æ–≤',  data.empValues, backgroundColor: '#9b59b6' }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // 2. –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
    const daysEl = document.getElementById('chart-days');
    if (daysEl && data.dayLabels?.length > 0) {
        new Chart(daysEl.getContext('2d'), {
            type: 'line',
             { labels: data.dayLabels, datasets: [{ label: '–ß–∞—Å–æ–≤',  data.dayValues, borderColor: '#3498db', fill: false, tension: 0.3 }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // 3. –¢–∏–ø—ã
    const wtEl = document.getElementById('chart-workout');
    if (wtEl && data.workoutLabels?.length > 0) {
        new Chart(wtEl.getContext('2d'), {
            type: 'doughnut',
             { labels: data.workoutLabels, datasets: [{  data.workoutValues, backgroundColor: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'] }] },
            options: { responsive: true, plugins: { legend: { position: 'right' } } }
        });
    }

    // 4. –î–Ω–∏ –º–µ—Å—è—Ü–∞
    const datesEl = document.getElementById('chart-dates');
    if (datesEl && data.dateLabels?.length > 0) {
        new Chart(datesEl.getContext('2d'), {
            type: 'bar',
             { labels: data.dateLabels, datasets: [{ label: '–ß–∞—Å–æ–≤',  data.dateValues, backgroundColor: '#3498db' }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }
});
</script>
{% endblock %}