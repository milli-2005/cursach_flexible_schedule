{% extends "core/base.html" %}
{% load custom_filters %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî {{ block.super }}{% endblock %}

{% block content %}
<div class="management-container">
    <h2 class="mb-4">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>


    <!-- –§–ò–õ–¨–¢–†–´ -->
    <form method="get" class="row g-3 mb-4 p-3 bg-dark rounded">
        <div class="col-md-2">
            <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
            <select name="period" class="form-select" onchange="this.form.submit()">
                <option value="week" {% if period == 'week' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
                <option value="month" {% if period == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                <option value="year" {% if period == 'year' %}selected{% endif %}>–ì–æ–¥</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
            <select name="employee" class="form-select" onchange="this.form.submit()">
                <option value="all">–í—Å–µ</option>
                {% for emp in all_employees %}
                    <option value="{{ emp.id }}" {% if employee_id|slugify == emp.id|slugify %}selected{% endif %}>
                        {{ emp.user.username }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç–∏—è</label>
            <select name="workout" class="form-select" onchange="this.form.submit()">
                <option value="all">–í—Å–µ</option>
                {% for wt in workout_types %}
                    <option value="{{ wt.id }}" {% if workout_id|slugify == wt.id|slugify %}selected{% endif %}>
                        {{ wt.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">–ü–æ–∏—Å–∫</label>
            <input type="text" name="search" class="form-control" placeholder="–ò–º—è –∏–ª–∏ —Ç–∏–ø..." value="{{ search_query }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </form>

    <!-- –ú–ï–¢–†–ò–ö–ò -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-gradient-primary text-white p-3">
                <div class="fs-4">{{ total_all_hours|floatformat:0 }} —á</div>
                <div class="text-white-50">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-warning text-white p-3">
                <div class="fs-4">
                    {% if hour_rate %}
                        {{ total_salary }} ‚ÇΩ
                    {% else %}
                        ‚Äî
                    {% endif %}
                </div>
                <div class="text-white-50">–û–±—â–∞—è –ó–ü</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-info text-white p-3">
                <div class="fs-4">{{ active_employees }}</div>
                <div class="text-white-50">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
            </div>
        </div>
        <div class="col-md-3">
            <a href="{% url 'export_operational_excel' %}?{% if period %}period={{ period }}&{% endif %}{% if employee_id != 'all' %}employee={{ employee_id }}&{% endif %}{% if workout_id != 'all' %}workout={{ workout_id }}&{% endif %}{% if search_query %}search={{ search_query }}{% endif %}"
               class="btn btn-success w-100 h-100 d-flex align-items-center justify-content-center">
                <i class="bi bi-file-earmark-excel me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç Excel
            </a>
        </div>
    </div>

    <!-- –ì–†–ê–§–ò–ö–ò -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>
                <div class="card-body"><canvas id="chart-emp" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">–ù–∞–≥—Ä—É–∑–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</div>
                <div class="card-body"><canvas id="chart-days" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">–ü–æ —Ç–∏–ø–∞–º –∑–∞–Ω—è—Ç–∏–π</div>
                <div class="card-body"><canvas id="chart-workout" height="200"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞</div>
                <div class="card-body"><canvas id="chart-dates" height="200"></canvas></div>
            </div>
        </div>
    </div>

    <!-- –¢–ê–ë–ï–õ–¨ -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>üìã –¢–∞–±–µ–ª—å —É—á—ë—Ç–∞ –∑–∞ {{ all_dates.0|date:"F Y" }}</span>
            <a href="{% url 'export_operational_excel' %}?{% if period %}period={{ period }}&{% endif %}{% if employee_id != 'all' %}employee={{ employee_id }}&{% endif %}{% if workout_id != 'all' %}workout={{ workout_id }}&{% endif %}{% if search_query %}search={{ search_query }}{% endif %}"
               class="btn btn-success btn-sm">
                <i class="bi bi-file-earmark-excel me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç Excel
            </a>
        </div>

        <!-- –°–¢–ê–í–ö–ê –ó–ê –ß–ê–° -->
        <div class="card-body border-bottom">
            <form method="get" class="d-inline-flex align-items-center gap-2 flex-wrap">
                {% for key, value in request.GET.items %}
                    {% if key != 'hour_rate' and key != 'set_hour_rate' and key != 'reset_rate' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
                <strong>–°—Ç–∞–≤–∫–∞:</strong>
                <input type="number" name="hour_rate" value="{% if hour_rate %}{{ hour_rate|floatformat:0 }}{% endif %}" min="0" step="1" class="form-control form-control-sm" style="width:100px;" placeholder="‚ÇΩ/—á–∞—Å">
                <button type="submit" name="set_hour_rate" class="btn btn-sm btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                {% if hour_rate %}
                    <a href="?reset_rate=1" class="btn btn-sm btn-outline-secondary ms-2">–°–±—Ä–æ—Å–∏—Ç—å</a>
                {% endif %}
            </form>
        </div>

        <!-- –¢–ê–ë–õ–ò–¶–ê -->
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-dark text-center">
                    <thead>
                        <tr>
                            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            {% for d in all_dates %}
                                <th style="min-width:40px;">
                                    {{ d.day }}<br><small>{{ d|date:"D" }}</small>
                                </th>
                            {% endfor %}
                            <th>–ß–∞—Å–æ–≤</th>
                            <th>–ó–ü</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp in employees %}
                            <tr>
                                <td>{{ emp.user.username }}</td>
                                {% for d in all_dates %}
                                    {% with hours=data|get_item:emp.id|get_item:d %}
                                        <td class="{% if hours > 0 %}bg-success text-white{% else %}bg-light text-dark{% endif %}">
                                            {% if hours > 0 %}{{ hours|floatformat:0 }}{% else %}0{% endif %}
                                        </td>
                                    {% endwith %}
                                {% endfor %}
                                <td>{{ total_hours|get_item:emp.id|floatformat:0 }}</td>
                                <td>
                                    {% if hour_rate %}
                                        {{ total_hours|get_item:emp.id|multiply:hour_rate|floatformat:0 }}
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}

                        <!-- –ò–¢–û–ì–û –ü–û –î–ù–Ø–ú -->
                        <tr class="fw-bold bg-secondary">
                            <td>–ò—Ç–æ–≥–æ –ø–æ –¥–Ω—è–º</td>
                            {% for total in daily_totals %}
                                <td>{{ total }}</td>
                            {% endfor %}
                            <td>{{ total_all_hours|floatformat:0 }}</td>
                            <td>
                                {% if hour_rate %}
                                    {{ total_all_hours|multiply:hour_rate|floatformat:0 }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- –î–ê–ù–ù–´–ï -->
<script id="report-data" type="application/json">
{{ chart_data_json|safe }}
</script>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataEl = document.getElementById('report-data');
    if (!dataEl) return;

    let data;
    try {
        data = JSON.parse(dataEl.textContent);
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:", e);
        return;
    }

    // 1. –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
    const empEl = document.getElementById('chart-emp');
    if (empEl && data.empNames?.length > 0) {
        new Chart(empEl.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.empNames,
                datasets: [{
                    label: '–ß–∞—Å–æ–≤',
                    data: data.empValues,
                    backgroundColor: '#9b59b6'
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // 2. –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
    const daysEl = document.getElementById('chart-days');
    if (daysEl && data.dayLabels?.length > 0) {
        new Chart(daysEl.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.dayLabels,
                datasets: [{
                    label: '–ß–∞—Å–æ–≤',
                    data: data.dayValues,
                    borderColor: '#3498db',
                    fill: false,
                    tension: 0.3
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // 3. –¢–∏–ø—ã
    const wtEl = document.getElementById('chart-workout');
    if (wtEl && data.workoutLabels?.length > 0) {
        new Chart(wtEl.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: data.workoutLabels,
                datasets: [{
                    data: data.workoutValues,
                    backgroundColor: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12']
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'right' } } }
        });
    }

    // 4. –î–Ω–∏ –º–µ—Å—è—Ü–∞
    const datesEl = document.getElementById('chart-dates');
    if (datesEl && data.dateLabels?.length > 0) {
        new Chart(datesEl.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.dateLabels,
                datasets: [{
                    label: '–ß–∞—Å–æ–≤',
                    data: data.dateValues,
                    backgroundColor: '#3498db'
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ (–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π)
document.querySelector('input[name="search"]').addEventListener('input', function(e) {
    clearTimeout(window.searchTimer);
    window.searchTimer = setTimeout(() => {
        this.form.submit();
    }, 500); // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ 500–º—Å –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–≤–æ–¥–∞
});
});
</script>
{% endblock %}