<!-- templates/core/schedules/create_schedule.html -->
{% extends "core/base.html" %}
{% load dict_extras %}

{% block title %}Создание графика - {{ block.super }}{% endblock %}

{% block content %}
<div class="management-container">
    {% csrf_token %}
    <h2>Создание недельного графика</h2>

    <div class="mb-3">
        <button id="auto-fill-btn" class="btn btn-outline-light">Заполнить автоматически</button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-dark" id="schedule-table">
            <thead>
                <tr>
                    <th>Время</th>
                    {% for day in days %}
                        <th>{{ day|date:"D, d M" }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
    {% for slot in slots %}
        <tr>
            <td>{{ slot.0 }} – {{ slot.1 }}</td>
            {% for day_str in date_strings %}
                <td data-day="{{ day_str }}" data-time="{{ slot.0 }}">
                    <select class="form-select form-select-sm mb-1 employee-select">
                        <option value="">Выберите...</option>
                        {% for emp in employees %}
                            <option value="{{ emp.id }}"
                                {% if availability_dict|get_item:emp.id|get_item:day_str|get_item:slot.0 %}
                                    disabled style="color: #666;"
                                {% endif %}>
                                {{ emp.user.username }}
                            </option>
                        {% endfor %}
                    </select>
                    <select class="form-select form-select-sm workout-select">
                        <option value="">Занятие</option>
                        {% for wt in workout_types %}
                            <option value="{{ wt.id }}">{{ wt.name }}</option>
                        {% endfor %}
                    </select>
                </td>
            {% endfor %}
        </tr>
    {% endfor %}
</tbody>
        </table>
    </div>
    <button id="save-schedule-btn" class="btn btn-primary">Сохранить график</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Загружаем данные о доступности: ["1,2026-01-27,09:00", "2,2026-01-27,10:00", ...]
const AVAILABILITY_SET = new Set({{ availability_set_json|safe }});

document.getElementById('auto-fill-btn').addEventListener('click', function () {
    const rows = document.querySelectorAll('#schedule-table tbody tr');
    const employees = Array.from(document.querySelectorAll('.employee-select option[value]'))
        .map(opt => ({ id: opt.value, name: opt.textContent }));

    let empIndex = 0;

    rows.forEach(row => {
        const timeCell = row.querySelector('td:first-child');
        if (!timeCell) return;

        const timeText = timeCell.textContent.trim(); // "09:00 – 09:50"
        const startTime = timeText.split('–')[0].trim(); // "09:00"

        row.querySelectorAll('td:not(:first-child)').forEach((cell, idx) => {
            const day = cell.dataset.day; // "2026-01-27"
            const employeeSelect = cell.querySelector('.employee-select');
            const workoutSelect = cell.querySelector('.workout-select');

            // Пропускаем, если уже заполнено
            if (employeeSelect.value) return;

            // Ищем первого ДОСТУПНОГО сотрудника
            let assigned = false;
            for (let i = 0; i < employees.length; i++) {
                const emp = employees[(empIndex + i) % employees.length];
                const key = `${emp.id},${day},${startTime}`;

                if (AVAILABILITY_SET.has(key)) {
                    employeeSelect.value = emp.id;
                    if (workoutSelect.options.length > 1) {
                        workoutSelect.value = workoutSelect.options[1].value;
                    }
                    empIndex = (empIndex + i + 1) % employees.length;
                    assigned = true;
                    break;
                }
            }

            if (!assigned) {
                employeeSelect.value = '';
                workoutSelect.value = '';
            }
        });
    });

    showGlobalNotification('График заполнен с учётом доступности сотрудников.');
});
</script>

<script>
// === СОХРАНЕНИЕ ===
document.getElementById('save-schedule-btn').addEventListener('click', function () {
    const scheduleName = prompt("Введите название графика:", "График на неделю");
    if (!scheduleName) return;

    const assignments = [];
    const rows = document.querySelectorAll('#schedule-table tbody tr');
    const dateStrings = {{ date_strings|safe }};

    rows.forEach(row => {
        const timeSlot = row.querySelector('td:first-child').textContent.trim();
        row.querySelectorAll('td:not(:first-child)').forEach((cell, idx) => {
            const employeeSelect = cell.querySelector('.employee-select');
            const workoutSelect = cell.querySelector('.workout-select');
            if (employeeSelect.value) {
                assignments.push({
                    employee_id: parseInt(employeeSelect.value),
                    workout_type_id: workoutSelect.value ? parseInt(workoutSelect.value) : null,
                    date: dateStrings[idx],
                    time_slot: timeSlot
                });
            }
        });
    });

    fetch('/api/schedule/save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf-token]').content
        },
        body: JSON.stringify({
            name: scheduleName,
            start_date: dateStrings[0],
            end_date: dateStrings[dateStrings.length - 1],
            assignments: assignments
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showGlobalNotification('График успешно сохранён!');
            window.location.href = '/schedules/';
        } else {
            showGlobalNotification('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(e => {
        console.error(e);
        showGlobalNotification('Ошибка сети');
    });
});
</script>
{% endblock %}