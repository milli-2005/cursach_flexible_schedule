{% extends "core/base.html" %}
{% load static %}
{% load dict_extras %}

{% block title %}Редактирование графика - {{ block.super }}{% endblock %}

{% block content %}
<div class="management-container">
    <h2>Редактирование графика "{{ schedule.name }}"</h2>
    <p class="text-muted">Период: {{ schedule.start_date }} — {{ schedule.end_date }}</p>
    <div class="mb-3">
    <button id="auto-fill-btn" class="btn btn-outline-light">Заполнить автоматически</button>
</div>

    <div class="table-responsive">
        <table class="table table-bordered table-dark">
            <thead>
                <tr>
                    <th>Время</th>
                    {% for day in days %}
                        <th>{{ day|date:"D, d M" }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for slot in slots %}
                <tr>
                    <td>{{ slot }}</td>
                    {% for day in days %}
                    <td>
                        {% with time_key=slot|slice:":5" %}
                            {% with date_assignments=assignment_dict|get_item:day %}
                                {% with assignment=date_assignments|get_item:time_key %}
                                <select class="form-select form-select-sm mb-1 employee-select">
                                    <option value="">Выберите...</option>
                                    {% for emp in employees %}
                                        <option value="{{ emp.id }}"
                                            {% if assignment and assignment.employee.id == emp.id %}selected{% endif %}>
                                            {{ emp.user.username }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-select-sm workout-select">
                                    <option value="">Занятие</option>
                                    {% for wt in workout_types %}
                                        <option value="{{ wt.id }}"
                                            {% if assignment and assignment.workout_type and assignment.workout_type.id == wt.id %}selected{% endif %}>
                                            {{ wt.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% endwith %}
                            {% endwith %}
                        {% endwith %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <button id="save-schedule-btn" class="btn btn-primary">Сохранить изменения</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Данные о доступности
const AVAILABILITY_SET = new Set({{ availability_set_json|safe }});

document.getElementById('auto-fill-btn').addEventListener('click', function () {
    const rows = document.querySelectorAll('tbody tr');
    const employees = Array.from(document.querySelectorAll('.employee-select option[value]'))
        .map(opt => ({ id: opt.value, name: opt.textContent }));

    let empIndex = 0;

    rows.forEach(row => {
        const timeCell = row.querySelector('td:first-child');
        if (!timeCell) return;

        const timeText = timeCell.textContent.trim();
        const startTime = timeText.split('–')[0].trim();

        row.querySelectorAll('td:not(:first-child)').forEach((cell, idx) => {
            const day = "{{ date_strings|join:'|' }}".split('|')[idx];
            const employeeSelect = cell.querySelector('.employee-select');
            const workoutSelect = cell.querySelector('.workout-select');

            // Пропускаем, если уже заполнено
            if (employeeSelect.value) return;

            // Ищем первого доступного
            let assigned = false;
            for (let i = 0; i < employees.length; i++) {
                const emp = employees[(empIndex + i) % employees.length];
                const key = `${emp.id},${day},${startTime}`;

                if (AVAILABILITY_SET.has(key)) {
                    employeeSelect.value = emp.id;
                    if (workoutSelect.options.length > 1) {
                        workoutSelect.value = workoutSelect.options[1].value;
                    }
                    empIndex = (empIndex + i + 1) % employees.length;
                    assigned = true;
                    break;
                }
            }

            if (!assigned) {
                employeeSelect.value = '';
                workoutSelect.value = '';
            }
        });
    });

    alert('График заполнен с учётом доступности сотрудников.');
});
</script>

<!-- ОСТАЛЬНЫЙ JS (сохранение) остаётся без изменений -->
<script>
document.getElementById('save-schedule-btn').addEventListener('click', function () {
    const scheduleId = {{ schedule.id }};
    const assignments = [];

    const days = [
        {% for d in days %}
            "{{ d|date:'Y-m-d' }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    document.querySelectorAll('tbody tr').forEach(row => {
        const fullTimeText = row.querySelector('td:first-child').textContent.trim();
        const startTime = fullTimeText.split('–')[0].trim();

        row.querySelectorAll('td:not(:first-child)').forEach((cell, colIndex) => {
            const day = days[colIndex];
            const employeeSelect = cell.querySelector('.employee-select');
            const workoutSelect = cell.querySelector('.workout-select');

            const employeeId = employeeSelect ? employeeSelect.value : null;
            const workoutTypeId = workoutSelect ? workoutSelect.value : null;

            if (employeeId || workoutTypeId) {
                assignments.push({
                    date: day,
                    time_slot: startTime,
                    employee_id: employeeId || null,
                    workout_type_id: workoutTypeId || null
                });
            }
        });
    });

    const csrftoken = document.querySelector('[name=csrf-token]').content;

    fetch(`/api/schedule/${scheduleId}/update/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ assignments: assignments })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('График успешно сохранён!');
            window.location.href = "{% url 'schedule_detail' schedule.id %}";
        } else {
            alert('Ошибка сохранения: ' + (data.error || JSON.stringify(data)));
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Не удалось отправить данные.');
    });
});
</script>
{% endblock %}